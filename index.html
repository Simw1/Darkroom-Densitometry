<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Film Process Control - Westminster Darkroom</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@500&family=Space+Grotesk:wght@600;700&display=swap" rel="stylesheet">
  <style>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DESIGN TOKENS â€” CSS Custom Properties
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    :root {
      /* Typography */
      --font-display: 'Space Grotesk', system-ui, sans-serif;
      --font-body: 'Inter', system-ui, sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
      
      /* Spacing */
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-6: 24px;
      --space-8: 32px;
      
      /* Border Radius */
      --radius-sm: 4px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-full: 9999px;
      
      /* Motion */
      --duration-micro: 100ms;
      --duration-fast: 150ms;
      --duration-normal: 250ms;
      --duration-slow: 400ms;
      --ease-default: cubic-bezier(0.4, 0, 0.2, 1);
      --ease-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);
      
      /* Functional Colours (base) */
      --ok: #22c55e;
      --action: #f59e0b;
      --control: #ef4444;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LIGHT MODE (Default)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    [data-theme="light"] {
      --bg: #fafafa;
      --surface: #ffffff;
      --surface-alt: #f9f7f5;
      --border: #e2e8f0;
      --border-strong: #cbd5e1;
      --text-muted: #64748b;
      --text: #1e293b;
      --text-strong: #020617;
      --accent: #4f46e5;
      --accent-hover: #4338ca;
      
      --ok: #16a34a;
      --action: #d97706;
      --control: #dc2626;
      
      --card-shadow: 0 1px 3px rgba(0,0,0,0.08);
      --input-bg: #ffffff;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DARK MODE
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    [data-theme="dark"] {
      --bg: #0f0f1a;
      --surface: #1a1a2e;
      --surface-alt: #16213e;
      --border: #334155;
      --border-strong: #475569;
      --text-muted: #94a3b8;
      --text: #e2e8f0;
      --text-strong: #ffffff;
      --accent: #818cf8;
      --accent-hover: #a5b4fc;
      
      --ok: #22c55e;
      --action: #f59e0b;
      --control: #ef4444;
      
      --card-shadow: none;
      --input-bg: #0f0f1a;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DISCO MODE ğŸª©
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    [data-theme="disco"] {
      --bg: #0a0a0a;
      --surface: #0f0f0f;
      --surface-alt: #141414;
      --border: #333333;
      --border-strong: #444444;
      --text-muted: #a0a0a0;
      --text: #f0f0f0;
      --text-strong: #ffffff;
      --accent: #ff00ff;
      --accent-hover: #ff66ff;
      
      --ok: #00ff00;
      --action: #ffff00;
      --control: #ff0000;
      
      --card-shadow: 0 0 20px rgba(255, 0, 255, 0.15);
      --input-bg: #0a0a0a;
    }
    
    /* Disco background animation */
    @keyframes disco-bg {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    @keyframes disco-glow {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }
    
    @keyframes disco-border {
      0% { border-color: #ff00ff; box-shadow: 0 0 10px #ff00ff40; }
      25% { border-color: #00ffff; box-shadow: 0 0 10px #00ffff40; }
      50% { border-color: #ffff00; box-shadow: 0 0 10px #ffff0040; }
      75% { border-color: #00ff00; box-shadow: 0 0 10px #00ff0040; }
      100% { border-color: #ff00ff; box-shadow: 0 0 10px #ff00ff40; }
    }
    
    @keyframes disco-pulse-ok {
      0%, 100% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff0080; }
      50% { box-shadow: 0 0 10px #00ff00, 0 0 20px #00ff00; }
    }
    
    @keyframes disco-pulse-action {
      0%, 100% { box-shadow: 0 0 5px #ffff00, 0 0 10px #ffff0080; }
      50% { box-shadow: 0 0 10px #ffff00, 0 0 20px #ffff00; }
    }
    
    @keyframes disco-pulse-control {
      0%, 100% { box-shadow: 0 0 5px #ff0000, 0 0 10px #ff000080; }
      50% { box-shadow: 0 0 10px #ff0000, 0 0 20px #ff0000; }
    }
    
    @keyframes rainbow-btn {
      0% { background-position: 0% 50%; }
      100% { background-position: 200% 50%; }
    }
    
    [data-theme="disco"] body {
      background: linear-gradient(-45deg, #0a0a0a, #1a0a1a, #0a1a1a, #1a1a0a, #0a0a0a);
      background-size: 400% 400%;
      animation: disco-bg 20s ease infinite;
    }
    
    [data-theme="disco"] .card {
      border: 2px solid transparent;
      animation: disco-border 3s linear infinite;
    }
    
    [data-theme="disco"] .status-banner.ok {
      animation: disco-pulse-ok 1s ease-in-out infinite;
    }
    
    [data-theme="disco"] .status-banner.action {
      animation: disco-pulse-action 1s ease-in-out infinite;
    }
    
    [data-theme="disco"] .status-banner.control {
      animation: disco-pulse-control 1s ease-in-out infinite;
    }
    
    [data-theme="disco"] .btn-primary {
      background: linear-gradient(90deg, #ff00ff, #00ffff, #ffff00, #00ff00, #ff00ff);
      background-size: 200% auto;
      animation: rainbow-btn 2s linear infinite;
      color: #000;
      font-weight: 600;
    }
    
    [data-theme="disco"] .btn-primary:hover {
      animation-duration: 0.5s;
    }
    
    [data-theme="disco"] header h1 {
      background: linear-gradient(90deg, #ff00ff, #00ffff, #ffff00, #ff00ff);
      background-size: 200% auto;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: rainbow-btn 3s linear infinite;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       BASE STYLES
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: var(--font-body);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: var(--space-4);
      transition: background-color var(--duration-normal) var(--ease-default),
                  color var(--duration-normal) var(--ease-default);
    }
    
    .container { max-width: 1200px; margin: 0 auto; }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       HEADER
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-6);
      padding-bottom: var(--space-4);
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
      gap: var(--space-4);
    }
    
    .header-text h1 {
      font-family: var(--font-display);
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-strong);
      letter-spacing: -0.02em;
      margin-bottom: var(--space-1);
    }
    
    .header-text p {
      color: var(--text-muted);
      font-size: 0.875rem;
    }
    
    /* Theme Toggle */
    .theme-toggle {
      display: flex;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-full);
      padding: var(--space-1);
      gap: var(--space-1);
    }
    
    .theme-btn {
      padding: var(--space-2) var(--space-3);
      border: none;
      border-radius: var(--radius-full);
      background: transparent;
      color: var(--text-muted);
      font-family: var(--font-body);
      font-size: 0.875rem;
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-default);
    }
    
    .theme-btn:hover {
      color: var(--text);
    }
    
    .theme-btn.active {
      background: var(--accent);
      color: white;
    }
    
    [data-theme="disco"] .theme-btn.active {
      background: linear-gradient(90deg, #ff00ff, #00ffff);
      color: #000;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PROCESS TABS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    .process-tabs {
      display: flex;
      gap: var(--space-2);
      margin-bottom: var(--space-6);
    }
    
    .tab {
      flex: 1;
      padding: var(--space-3) var(--space-4);
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: var(--radius-md);
      color: var(--text);
      font-family: var(--font-body);
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-default);
    }
    
    .tab:hover {
      border-color: var(--border-strong);
    }
    
    .tab.active {
      border-color: var(--ok);
      background: color-mix(in srgb, var(--ok) 10%, var(--surface));
    }
    
    [data-theme="disco"] .tab.active {
      animation: disco-border 3s linear infinite;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CARDS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: var(--space-6);
      margin-bottom: var(--space-4);
      box-shadow: var(--card-shadow);
      transition: all var(--duration-normal) var(--ease-default);
    }
    
    .card h2 {
      font-family: var(--font-display);
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: var(--space-4);
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       REFERENCE SECTION
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    .reference-section {
      display: flex;
      gap: var(--space-3);
      align-items: flex-start;
      flex-wrap: wrap;
    }
    
    .reference-status {
      padding: var(--space-3) var(--space-4);
      background: color-mix(in srgb, var(--ok) 10%, var(--surface));
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      flex: 1;
      min-width: 200px;
    }
    
    .reference-status.missing {
      background: color-mix(in srgb, var(--control) 10%, var(--surface));
      color: var(--control);
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       BUTTONS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    .btn {
      padding: var(--space-2) var(--space-4);
      border-radius: var(--radius-md);
      border: none;
      cursor: pointer;
      font-family: var(--font-body);
      font-size: 0.875rem;
      font-weight: 500;
      transition: all var(--duration-fast) var(--ease-default);
    }
    
    .btn-primary {
      background: var(--accent);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
    }
    
    .btn-secondary {
      background: var(--surface-alt);
      color: var(--text);
      border: 1px solid var(--border);
    }
    
    .btn-secondary:hover {
      background: var(--border);
    }
    
    .btn-danger {
      background: var(--control);
      color: white;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       INPUT GRID
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    .input-grid {
      display: grid;
      gap: var(--space-3);
    }
    
    .input-grid.c41 { grid-template-columns: 1fr; }
    .input-grid.bw { grid-template-columns: repeat(4, 1fr); }
    
    .input-group {
      display: flex;
      flex-direction: column;
      gap: var(--space-1);
    }
    
    .input-group label {
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .input-group input {
      padding: var(--space-3);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--input-bg);
      color: var(--text);
      font-family: var(--font-mono);
      font-size: 1rem;
      width: 100%;
      transition: border-color var(--duration-fast) var(--ease-default);
    }
    
    .input-group input:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    [data-theme="disco"] .input-group input:focus {
      border-color: #ff00ff;
      box-shadow: 0 0 10px #ff00ff40;
    }
    
    .row-label {
      font-family: var(--font-display);
      font-weight: 600;
      padding-top: var(--space-3);
      border-top: 1px solid var(--border);
      margin-top: var(--space-2);
      color: var(--text-strong);
    }
    
    .row-label:first-child {
      border-top: none;
      margin-top: 0;
      padding-top: 0;
    }
    
    .channel-inputs {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--space-2);
    }
    
    .channel-inputs .input-group label.r { color: #f87171; }
    .channel-inputs .input-group label.g { color: #4ade80; }
    .channel-inputs .input-group label.b { color: #60a5fa; }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RESULTS PANEL
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    .results-panel {
      display: none;
    }
    
    .results-panel.visible {
      display: block;
    }
    
    .status-banner {
      padding: var(--space-4);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-4);
      font-family: var(--font-display);
      font-weight: 600;
      font-size: 1.125rem;
      text-align: center;
      transition: all var(--duration-normal) var(--ease-default);
    }
    
    .status-banner.ok {
      background: color-mix(in srgb, var(--ok) 15%, var(--surface));
      color: var(--ok);
    }
    
    .status-banner.action {
      background: color-mix(in srgb, var(--action) 15%, var(--surface));
      color: var(--action);
    }
    
    .status-banner.control {
      background: color-mix(in srgb, var(--control) 15%, var(--surface));
      color: var(--control);
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DEVIATIONS TABLE
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    .deviations-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: var(--space-4);
      font-family: var(--font-mono);
      font-size: 0.875rem;
    }
    
    .deviations-table th,
    .deviations-table td {
      padding: var(--space-2) var(--space-3);
      text-align: center;
      border: 1px solid var(--border);
    }
    
    .deviations-table th {
      background: var(--surface-alt);
      color: var(--text-muted);
      font-family: var(--font-body);
      font-weight: 500;
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.05em;
    }
    
    .deviations-table td.ok { color: var(--ok); }
    .deviations-table td.action {
      color: var(--action);
      background: color-mix(in srgb, var(--action) 10%, var(--surface));
    }
    .deviations-table td.control {
      color: var(--control);
      background: color-mix(in srgb, var(--control) 10%, var(--surface));
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PROBLEM CARDS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    .problem-card {
      background: var(--surface-alt);
      border-radius: var(--radius-md);
      padding: var(--space-4);
      margin-bottom: var(--space-3);
      border-left: 4px solid var(--action);
    }
    
    .problem-card.control {
      border-left-color: var(--control);
    }
    
    .problem-card.ok {
      border-left-color: var(--ok);
    }
    
    .problem-card h3 {
      font-family: var(--font-display);
      margin-bottom: var(--space-2);
      font-size: 1rem;
      color: var(--text-strong);
    }
    
    .problem-card .cause {
      color: var(--text-muted);
      margin-bottom: var(--space-2);
      font-size: 0.875rem;
    }
    
    .problem-card .action-text {
      margin-bottom: var(--space-2);
      font-size: 0.875rem;
    }
    
    .problem-card .ref {
      font-size: 0.75rem;
      color: var(--text-muted);
      font-family: var(--font-mono);
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       NOTES FIELD
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    .notes-field {
      width: 100%;
      min-height: 80px;
      padding: var(--space-3);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      background: var(--input-bg);
      color: var(--text);
      font-family: var(--font-body);
      font-size: 0.875rem;
      resize: vertical;
      transition: border-color var(--duration-fast) var(--ease-default);
    }
    
    .notes-field:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ACTION BUTTONS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    .action-buttons {
      display: flex;
      gap: var(--space-3);
      margin-top: var(--space-4);
    }
    
    .action-buttons .btn {
      flex: 1;
      padding: var(--space-3);
      font-size: 1rem;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       HISTORY TABLE
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    .history-scroll {
      max-height: 250px;
      overflow-y: auto;
    }
    
    .history-table {
      width: 100%;
      border-collapse: collapse;
      font-family: var(--font-mono);
      font-size: 0.75rem;
    }
    
    .history-table th,
    .history-table td {
      padding: var(--space-2);
      text-align: center;
      border: 1px solid var(--border);
    }
    
    .history-table th {
      background: var(--surface-alt);
      color: var(--text-muted);
      font-family: var(--font-body);
      font-weight: 500;
      position: sticky;
      top: 0;
    }
    
    .history-table tr:hover {
      background: color-mix(in srgb, var(--accent) 5%, var(--surface));
    }
    
    #noHistory {
      color: var(--text-muted);
      text-align: center;
      padding: var(--space-4);
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MODAL
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      align-items: center;
      justify-content: center;
      z-index: 100;
      backdrop-filter: blur(4px);
    }
    
    .modal.visible {
      display: flex;
    }
    
    .modal-content {
      background: var(--surface);
      padding: var(--space-6);
      border-radius: var(--radius-lg);
      max-width: 500px;
      width: 90%;
      border: 1px solid var(--border);
    }
    
    [data-theme="disco"] .modal-content {
      animation: disco-border 3s linear infinite;
      border-width: 2px;
    }
    
    .modal-content h2 {
      font-family: var(--font-display);
      color: var(--text-strong);
      margin-bottom: var(--space-4);
    }
    
    .modal-buttons {
      display: flex;
      gap: var(--space-2);
      margin-top: var(--space-4);
    }
    
    .modal-buttons .btn {
      flex: 1;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TOAST
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    .toast {
      position: fixed;
      bottom: var(--space-4);
      left: 50%;
      transform: translateX(-50%);
      background: var(--surface);
      padding: var(--space-3) var(--space-6);
      border-radius: var(--radius-full);
      border: 2px solid var(--ok);
      display: none;
      font-weight: 500;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    
    .toast.visible {
      display: block;
      animation: toast-in var(--duration-normal) var(--ease-bounce);
    }
    
    .toast.error {
      border-color: var(--control);
    }
    
    @keyframes toast-in {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RESPONSIVE
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    @media (max-width: 600px) {
      .input-grid.bw {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .channel-inputs {
        grid-template-columns: repeat(3, 1fr);
      }
      
      .reference-section {
        flex-direction: column;
      }
      
      .reference-status {
        width: 100%;
      }
      
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .theme-toggle {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="header-text">
        <h1>Film Process Control</h1>
        <p>University of Westminster Harrow Darkroom</p>
      </div>
      <div class="theme-toggle">
        <button class="theme-btn" data-theme="light">Light</button>
        <button class="theme-btn active" data-theme="dark">Dark</button>
        <button class="theme-btn" data-theme="disco">Disco âœ¨</button>
      </div>
    </header>
    
    <div class="process-tabs">
      <button class="tab active" data-process="c41">C-41 Colour</button>
      <button class="tab" data-process="bw">B&W</button>
    </div>
    
    <!-- Reference Values -->
    <div class="card">
      <h2>Reference Values</h2>
      <div class="reference-section">
        <div class="reference-status" id="refStatus">
          <span id="refStatusText">No reference set</span>
        </div>
        <button class="btn btn-primary" id="setRefBtn">Set Reference</button>
        <button class="btn btn-secondary" id="clearRefBtn">Clear</button>
      </div>
    </div>
    
    <!-- Data Entry -->
    <div class="card">
      <h2>Test Strip Readings <span style="color: var(--text-muted); font-weight: normal; text-transform: none; font-size: 0.75rem;">(values Ã—100)</span></h2>
      
      <!-- C-41 Inputs -->
      <div class="input-grid c41" id="c41Inputs">
        <div class="row-label">D-max</div>
        <div class="channel-inputs">
          <div class="input-group"><label class="r">Red</label><input type="number" id="dmax_r" step="1"></div>
          <div class="input-group"><label class="g">Green</label><input type="number" id="dmax_g" step="1"></div>
          <div class="input-group"><label class="b">Blue</label><input type="number" id="dmax_b" step="1"></div>
        </div>
        
        <div class="row-label">HD (High Density)</div>
        <div class="channel-inputs">
          <div class="input-group"><label class="r">Red</label><input type="number" id="hd_r" step="1"></div>
          <div class="input-group"><label class="g">Green</label><input type="number" id="hd_g" step="1"></div>
          <div class="input-group"><label class="b">Blue</label><input type="number" id="hd_b" step="1"></div>
        </div>
        
        <div class="row-label">LD (Low Density)</div>
        <div class="channel-inputs">
          <div class="input-group"><label class="r">Red</label><input type="number" id="ld_r" step="1"></div>
          <div class="input-group"><label class="g">Green</label><input type="number" id="ld_g" step="1"></div>
          <div class="input-group"><label class="b">Blue</label><input type="number" id="ld_b" step="1"></div>
        </div>
        
        <div class="row-label">D-min</div>
        <div class="channel-inputs">
          <div class="input-group"><label class="r">Red</label><input type="number" id="dmin_r" step="1"></div>
          <div class="input-group"><label class="g">Green</label><input type="number" id="dmin_g" step="1"></div>
          <div class="input-group"><label class="b">Blue</label><input type="number" id="dmin_b" step="1"></div>
        </div>
      </div>
      
      <!-- B&W Inputs -->
      <div class="input-grid bw" id="bwInputs" style="display: none;">
        <div class="input-group"><label>D-max</label><input type="number" id="bw_dmax" step="1"></div>
        <div class="input-group"><label>HD</label><input type="number" id="bw_hd" step="1"></div>
        <div class="input-group"><label>LD</label><input type="number" id="bw_ld" step="1"></div>
        <div class="input-group"><label>D-min</label><input type="number" id="bw_dmin" step="1"></div>
      </div>
      
      <div class="action-buttons">
        <button class="btn btn-primary" id="analyseBtn">Analyse</button>
        <button class="btn btn-secondary" id="clearInputsBtn">Clear</button>
      </div>
    </div>
    
    <!-- Results -->
    <div class="card results-panel" id="resultsPanel">
      <h2>Analysis Results</h2>
      
      <div class="status-banner" id="statusBanner">Process OK</div>
      
      <div id="deviationsContainer"></div>
      
      <h3 style="margin: var(--space-4) 0 var(--space-3); color: var(--text-muted); font-family: var(--font-display); font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em;">Diagnosis</h3>
      <div id="problemsContainer"></div>
      
      <h3 style="margin: var(--space-4) 0 var(--space-3); color: var(--text-muted); font-family: var(--font-display); font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em;">Notes</h3>
      <textarea class="notes-field" id="notesField" placeholder="Record any actions taken, observations, or other notes..."></textarea>
      
      <div class="action-buttons">
        <button class="btn btn-primary" id="logBtn">Log to Sheet</button>
      </div>
    </div>
    
    <!-- History -->
    <div class="card">
      <h2>Recent Readings (Last 5)</h2>
      <div class="history-scroll">
        <table class="history-table" id="historyTable">
          <thead id="historyHeader"></thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
      <p id="noHistory">No readings logged yet</p>
    </div>
  </div>
  
  <!-- Reference Modal -->
  <div class="modal" id="refModal">
    <div class="modal-content">
      <h2>Set Reference Values</h2>
      <p style="color: var(--text-muted); margin-bottom: var(--space-4); font-size: 0.875rem;">Enter the reference strip values. These will be stored and used to calculate deviations.</p>
      
      <div id="refModalInputs"></div>
      
      <div class="modal-buttons">
        <button class="btn btn-secondary" id="cancelRefBtn">Cancel</button>
        <button class="btn btn-primary" id="saveRefBtn">Save Reference</button>
      </div>
    </div>
  </div>
  
  <!-- Toast -->
  <div class="toast" id="toast"></div>
  
  <script src="diagnostics.js"></script>
  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // APP STATE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    const state = {
      process: 'c41',
      theme: 'dark',
      reference: {
        c41: null,
        bw: null
      },
      history: {
        c41: [],
        bw: []
      },
      lastResult: null
    };
    
    // Google Apps Script URL - UPDATE THIS
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwGD2os4_hIuACLi8nmQSEpaghLF0A_-RuYtP6mOUyMHXbalpWEUmXJQIBsGnNh0-tCqw/exec';
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DOM ELEMENTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    const tabs = document.querySelectorAll('.tab');
    const themeBtns = document.querySelectorAll('.theme-btn');
    const c41Inputs = document.getElementById('c41Inputs');
    const bwInputs = document.getElementById('bwInputs');
    const refStatus = document.getElementById('refStatus');
    const refStatusText = document.getElementById('refStatusText');
    const resultsPanel = document.getElementById('resultsPanel');
    const refModal = document.getElementById('refModal');
    const toast = document.getElementById('toast');
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INITIALIZATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function init() {
      loadFromStorage();
      applyTheme(state.theme);
      updateRefStatus();
      updateHistoryTable();
      
      // Theme switching
      themeBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const theme = btn.dataset.theme;
          state.theme = theme;
          applyTheme(theme);
          saveToStorage();
        });
      });
      
      // Tab switching
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          state.process = tab.dataset.process;
          tabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          
          c41Inputs.style.display = state.process === 'c41' ? 'grid' : 'none';
          bwInputs.style.display = state.process === 'bw' ? 'grid' : 'none';
          
          resultsPanel.classList.remove('visible');
          updateRefStatus();
          updateHistoryTable();
        });
      });
      
      // Buttons
      document.getElementById('setRefBtn').addEventListener('click', openRefModal);
      document.getElementById('clearRefBtn').addEventListener('click', clearReference);
      document.getElementById('analyseBtn').addEventListener('click', analyse);
      document.getElementById('clearInputsBtn').addEventListener('click', clearInputs);
      document.getElementById('logBtn').addEventListener('click', logToSheet);
      document.getElementById('cancelRefBtn').addEventListener('click', () => refModal.classList.remove('visible'));
      document.getElementById('saveRefBtn').addEventListener('click', saveReference);
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // THEME MANAGEMENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function applyTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      themeBtns.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.theme === theme);
      });
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STORAGE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function loadFromStorage() {
      const saved = localStorage.getItem('filmProcessControl');
      if (saved) {
        const data = JSON.parse(saved);
        state.reference = data.reference || { c41: null, bw: null };
        state.history = data.history || { c41: [], bw: [] };
        state.theme = data.theme || 'dark';
      }
    }
    
    function saveToStorage() {
      localStorage.setItem('filmProcessControl', JSON.stringify({
        reference: state.reference,
        history: state.history,
        theme: state.theme
      }));
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // REFERENCE MANAGEMENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function updateRefStatus() {
      const ref = state.reference[state.process];
      if (ref) {
        refStatus.classList.remove('missing');
        if (state.process === 'c41') {
          refStatusText.textContent = `Reference set: D-min R=${ref.dmin.r} G=${ref.dmin.g} B=${ref.dmin.b}`;
        } else {
          refStatusText.textContent = `Reference set: D-min=${ref.dmin}, LD=${ref.ld}, HD=${ref.hd}`;
        }
      } else {
        refStatus.classList.add('missing');
        refStatusText.textContent = 'No reference set â€” click "Set Reference" to begin';
      }
    }
    
    function openRefModal() {
      const container = document.getElementById('refModalInputs');
      
      if (state.process === 'c41') {
        container.innerHTML = `
          <div class="input-grid" style="gap: var(--space-2); margin-bottom: var(--space-2);">
            <div class="row-label" style="font-size: 0.875rem;">D-max</div>
            <div class="channel-inputs">
              <div class="input-group"><label class="r" style="font-size: 0.7rem;">R</label><input type="number" id="ref_dmax_r" step="1"></div>
              <div class="input-group"><label class="g" style="font-size: 0.7rem;">G</label><input type="number" id="ref_dmax_g" step="1"></div>
              <div class="input-group"><label class="b" style="font-size: 0.7rem;">B</label><input type="number" id="ref_dmax_b" step="1"></div>
            </div>
            <div class="row-label" style="font-size: 0.875rem;">HD</div>
            <div class="channel-inputs">
              <div class="input-group"><label class="r" style="font-size: 0.7rem;">R</label><input type="number" id="ref_hd_r" step="1"></div>
              <div class="input-group"><label class="g" style="font-size: 0.7rem;">G</label><input type="number" id="ref_hd_g" step="1"></div>
              <div class="input-group"><label class="b" style="font-size: 0.7rem;">B</label><input type="number" id="ref_hd_b" step="1"></div>
            </div>
            <div class="row-label" style="font-size: 0.875rem;">LD</div>
            <div class="channel-inputs">
              <div class="input-group"><label class="r" style="font-size: 0.7rem;">R</label><input type="number" id="ref_ld_r" step="1"></div>
              <div class="input-group"><label class="g" style="font-size: 0.7rem;">G</label><input type="number" id="ref_ld_g" step="1"></div>
              <div class="input-group"><label class="b" style="font-size: 0.7rem;">B</label><input type="number" id="ref_ld_b" step="1"></div>
            </div>
            <div class="row-label" style="font-size: 0.875rem;">D-min</div>
            <div class="channel-inputs">
              <div class="input-group"><label class="r" style="font-size: 0.7rem;">R</label><input type="number" id="ref_dmin_r" step="1"></div>
              <div class="input-group"><label class="g" style="font-size: 0.7rem;">G</label><input type="number" id="ref_dmin_g" step="1"></div>
              <div class="input-group"><label class="b" style="font-size: 0.7rem;">B</label><input type="number" id="ref_dmin_b" step="1"></div>
            </div>
          </div>
        `;
      } else {
        container.innerHTML = `
          <div class="input-grid bw" style="margin-bottom: var(--space-2);">
            <div class="input-group"><label>D-max</label><input type="number" id="ref_bw_dmax" step="1"></div>
            <div class="input-group"><label>HD</label><input type="number" id="ref_bw_hd" step="1"></div>
            <div class="input-group"><label>LD</label><input type="number" id="ref_bw_ld" step="1"></div>
            <div class="input-group"><label>D-min</label><input type="number" id="ref_bw_dmin" step="1"></div>
          </div>
        `;
      }
      
      refModal.classList.add('visible');
    }
    
    function saveReference() {
      if (state.process === 'c41') {
        state.reference.c41 = {
          dmax: { r: getVal('ref_dmax_r'), g: getVal('ref_dmax_g'), b: getVal('ref_dmax_b') },
          hd: { r: getVal('ref_hd_r'), g: getVal('ref_hd_g'), b: getVal('ref_hd_b') },
          ld: { r: getVal('ref_ld_r'), g: getVal('ref_ld_g'), b: getVal('ref_ld_b') },
          dmin: { r: getVal('ref_dmin_r'), g: getVal('ref_dmin_g'), b: getVal('ref_dmin_b') }
        };
      } else {
        state.reference.bw = {
          dmax: getVal('ref_bw_dmax'),
          hd: getVal('ref_bw_hd'),
          ld: getVal('ref_bw_ld'),
          dmin: getVal('ref_bw_dmin')
        };
      }
      
      saveToStorage();
      updateRefStatus();
      refModal.classList.remove('visible');
      showToast('Reference values saved');
    }
    
    function clearReference() {
      state.reference[state.process] = null;
      saveToStorage();
      updateRefStatus();
      showToast('Reference cleared');
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ANALYSIS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function analyse() {
      const ref = state.reference[state.process];
      if (!ref) {
        showToast('Set reference values first', true);
        return;
      }
      
      let result;
      
      if (state.process === 'c41') {
        const readings = {
          dmax: { r: getVal('dmax_r'), g: getVal('dmax_g'), b: getVal('dmax_b') },
          hd: { r: getVal('hd_r'), g: getVal('hd_g'), b: getVal('hd_b') },
          ld: { r: getVal('ld_r'), g: getVal('ld_g'), b: getVal('ld_b') },
          dmin: { r: getVal('dmin_r'), g: getVal('dmin_g'), b: getVal('dmin_b') },
          yellow_b: getVal('dmin_b')
        };
        
        result = diagnoseC41(readings, ref);
        result.readings = readings;
        displayC41Results(result);
      } else {
        const readings = {
          dmax: getVal('bw_dmax'),
          hd: getVal('bw_hd'),
          ld: getVal('bw_ld'),
          dmin: getVal('bw_dmin')
        };
        
        result = diagnoseBW(readings, ref);
        result.readings = readings;
        displayBWResults(result);
      }
      
      state.lastResult = result;
      resultsPanel.classList.add('visible');
    }
    
    function displayC41Results(result) {
      const banner = document.getElementById('statusBanner');
      banner.className = 'status-banner ' + result.status.overall;
      banner.textContent = result.status.overall === 'ok' ? 'âœ“ Process OK' :
                          result.status.overall === 'action' ? 'âš  Action Required' : 'âœ• Control Limit Exceeded';
      
      const container = document.getElementById('deviationsContainer');
      container.innerHTML = `
        <table class="deviations-table">
          <thead>
            <tr><th></th><th>Red</th><th>Green</th><th>Blue</th></tr>
          </thead>
          <tbody>
            <tr>
              <td>D-min</td>
              ${['r','g','b'].map(c => `<td class="${getDevClass(result.deviations.dmin[c], 'dmin')}">${formatDev(result.deviations.dmin[c])}</td>`).join('')}
            </tr>
            <tr>
              <td>LD</td>
              ${['r','g','b'].map(c => `<td class="${getDevClass(result.deviations.ld[c], 'ld')}">${formatDev(result.deviations.ld[c])}</td>`).join('')}
            </tr>
            <tr>
              <td>HD-LD</td>
              ${['r','g','b'].map(c => `<td class="${getDevClass(result.deviations.hdld[c], 'hdld')}">${formatDev(result.deviations.hdld[c])}</td>`).join('')}
            </tr>
          </tbody>
        </table>
      `;
      
      displayProblems(result.problems);
    }
    
    function displayBWResults(result) {
      const banner = document.getElementById('statusBanner');
      banner.className = 'status-banner ' + result.status.overall;
      banner.textContent = result.status.overall === 'ok' ? 'âœ“ Process OK' :
                          result.status.overall === 'action' ? 'âš  Action Required' : 'âœ• Control Limit Exceeded';
      
      const container = document.getElementById('deviationsContainer');
      container.innerHTML = `
        <table class="deviations-table">
          <thead>
            <tr><th>LD Dev</th><th>HD-LD</th><th>HD-LD Dev</th></tr>
          </thead>
          <tbody>
            <tr>
              <td class="${getDevClass(result.deviations.ld, 'ld', 'bw')}">${formatDev(result.deviations.ld)}</td>
              <td>${result.hdld}</td>
              <td class="${getDevClass(result.deviations.hdld, 'hdld', 'bw')}">${formatDev(result.deviations.hdld)}</td>
            </tr>
          </tbody>
        </table>
      `;
      
      displayProblems(result.problems);
    }
    
    function displayProblems(problems) {
      const container = document.getElementById('problemsContainer');
      container.innerHTML = problems.map(p => `
        <div class="problem-card ${p.severity || 'action'}">
          <h3>${p.name || p.issue}</h3>
          ${p.cause ? `<p class="cause"><strong>Cause:</strong> ${p.cause}</p>` : ''}
          <p class="action-text"><strong>Action:</strong> ${p.action}</p>
          ${p.manual_ref ? `<p class="ref">${p.manual_ref}</p>` : ''}
        </div>
      `).join('');
    }
    
    function getDevClass(value, type, process = 'c41') {
      const tol = TOLERANCES[process][type];
      if (!tol) return 'ok';
      const absVal = Math.abs(value);
      if (absVal > tol.control) return 'control';
      if (absVal > tol.action) return 'action';
      return 'ok';
    }
    
    function formatDev(value) {
      const sign = value >= 0 ? '+' : '';
      return sign + value;
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // HISTORY
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function updateHistoryTable() {
      const history = state.history[state.process].slice(-5).reverse();
      const headerEl = document.getElementById('historyHeader');
      const bodyEl = document.getElementById('historyBody');
      const noHistory = document.getElementById('noHistory');
      
      if (history.length === 0) {
        headerEl.innerHTML = '';
        bodyEl.innerHTML = '';
        noHistory.style.display = 'block';
        return;
      }
      
      noHistory.style.display = 'none';
      
      if (state.process === 'c41') {
        headerEl.innerHTML = `
          <tr>
            <th>Date</th>
            <th>D-min R</th><th>G</th><th>B</th>
            <th>LD R</th><th>G</th><th>B</th>
            <th>HD-LD R</th><th>G</th><th>B</th>
            <th>Status</th>
          </tr>
        `;
        bodyEl.innerHTML = history.map(h => `
          <tr>
            <td>${h.date}</td>
            <td>${h.readings.dmin.r}</td><td>${h.readings.dmin.g}</td><td>${h.readings.dmin.b}</td>
            <td>${h.readings.ld.r}</td><td>${h.readings.ld.g}</td><td>${h.readings.ld.b}</td>
            <td>${h.hdld?.r || '-'}</td><td>${h.hdld?.g || '-'}</td><td>${h.hdld?.b || '-'}</td>
            <td style="color: var(--${h.status})">${h.status.toUpperCase()}</td>
          </tr>
        `).join('');
      } else {
        headerEl.innerHTML = `
          <tr>
            <th>Date</th>
            <th>D-max</th><th>HD</th><th>LD</th><th>D-min</th>
            <th>HD-LD</th><th>Status</th>
          </tr>
        `;
        bodyEl.innerHTML = history.map(h => `
          <tr>
            <td>${h.date}</td>
            <td>${h.readings.dmax}</td>
            <td>${h.readings.hd}</td>
            <td>${h.readings.ld}</td>
            <td>${h.readings.dmin}</td>
            <td>${h.hdld || '-'}</td>
            <td style="color: var(--${h.status})">${h.status.toUpperCase()}</td>
          </tr>
        `).join('');
      }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // LOGGING
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function logToSheet() {
      if (!state.lastResult) {
        showToast('Run analysis first', true);
        return;
      }
      
      const entry = {
        date: new Date().toLocaleDateString('en-GB'),
        time: new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }),
        process: state.process,
        readings: state.lastResult.readings,
        deviations: state.lastResult.deviations,
        status: state.lastResult.status.overall,
        problems: state.lastResult.problems.map(p => p.name || p.issue).join('; '),
        notes: document.getElementById('notesField').value
      };
      
      if (state.process === 'c41') {
        entry.hdld = {
          r: entry.readings.hd.r - entry.readings.ld.r,
          g: entry.readings.hd.g - entry.readings.ld.g,
          b: entry.readings.hd.b - entry.readings.ld.b
        };
      } else {
        entry.hdld = entry.readings.hd - entry.readings.ld;
      }
      
      state.history[state.process].push(entry);
      if (state.history[state.process].length > 50) {
        state.history[state.process] = state.history[state.process].slice(-50);
      }
      saveToStorage();
      updateHistoryTable();
      
      if (APPS_SCRIPT_URL !== 'YOUR_APPS_SCRIPT_URL_HERE') {
        try {
          await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(entry)
          });
          showToast('Logged to sheet');
        } catch (err) {
          showToast('Saved locally (sheet unavailable)', true);
        }
      } else {
        showToast('Saved locally');
      }
      
      document.getElementById('notesField').value = '';
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UTILITIES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function getVal(id) {
      return parseInt(document.getElementById(id)?.value) || 0;
    }
    
    function clearInputs() {
      const inputs = state.process === 'c41' ? c41Inputs : bwInputs;
      inputs.querySelectorAll('input').forEach(i => i.value = '');
      resultsPanel.classList.remove('visible');
    }
    
    function showToast(message, isError = false) {
      toast.textContent = message;
      toast.className = 'toast visible' + (isError ? ' error' : '');
      setTimeout(() => toast.classList.remove('visible'), 3000);
    }
    
    // Start the app
    init();
  </script>
</body>
</html>
